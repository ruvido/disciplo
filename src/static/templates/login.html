<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disciplo - Login</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; line-height: 1.6; color: #333; background: #f8f9fa; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .login-container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; }
        .logo { text-align: center; margin-bottom: 2rem; }
        .logo h1 { font-size: 2rem; font-weight: 700; color: #333; margin-bottom: 0.5rem; }
        .logo p { color: #666; font-size: 0.9rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #333; }
        .form-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; transition: border-color 0.2s; }
        .form-input:focus { outline: none; border-color: #333; box-shadow: 0 0 0 2px rgba(51, 51, 51, 0.1); }
        .btn { width: 100%; background: #333; color: white; border: none; padding: 0.75rem 1rem; border-radius: 6px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        .btn:hover:not(:disabled) { background: #555; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
        .success { background: #efe; border: 1px solid #cfc; color: #3c3; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
        .loading { display: inline-flex; align-items: center; gap: 0.5rem; }
        .spinner { width: 16px; height: 16px; border: 2px solid #ffffff40; border-top: 2px solid #ffffff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 480px) {
            .login-container { margin: 1rem; padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="login-container" x-data="loginForm()">
        <div class="logo">
            <h1>Disciplo</h1>
            <p>Community Platform</p>
        </div>

        <div x-show="error" x-transition class="error" x-text="error"></div>
        <div x-show="success" x-transition class="success" x-text="success"></div>

        <form @submit.prevent="login">
            <div class="form-group">
                <label for="email">Email</label>
                <input 
                    type="email" 
                    id="email" 
                    x-model="email" 
                    class="form-input" 
                    placeholder="Enter your email"
                    required
                    :disabled="loading"
                >
            </div>

            <div class="form-group">
                <label for="password">Password</label>
                <input 
                    type="password" 
                    id="password" 
                    x-model="password" 
                    class="form-input" 
                    placeholder="Enter your password"
                    required
                    :disabled="loading"
                >
            </div>

            <button type="submit" class="btn" :disabled="loading">
                <span x-show="!loading">Sign In</span>
                <span x-show="loading" class="loading">
                    <span class="spinner"></span>
                    Signing in...
                </span>
            </button>
        </form>
    </div>

    <script>
        function loginForm() {
            return {
                email: '',
                password: '',
                loading: false,
                error: '',
                success: '',

                async login() {
                    this.loading = true;
                    this.error = '';
                    this.success = '';

                    try {
                        const response = await fetch('/api/collections/users/auth-with-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                identity: this.email,
                                password: this.password,
                            }),
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.success = 'Login successful! Redirecting...';
                            
                            // Store the JWT token in a secure cookie only
                            if (data.token) {
                                // Set cookie for authentication (secure only in production)
                                const isSecure = window.location.protocol === 'https:';
                                const cookieValue = `pb_auth=${data.token}; path=/; max-age=1209600; samesite=strict${isSecure ? '; secure' : ''}`;
                                document.cookie = cookieValue;
                                
                                // Store minimal user data (no sensitive information)
                                const userData = {
                                    id: data.record.id,
                                    name: data.record.name,
                                    email: data.record.email,
                                    admin: data.record.admin || false,
                                    verified: data.record.verified || false
                                };
                                localStorage.setItem('user_data', JSON.stringify(userData));
                                
                                // Determine redirect URL based on admin status
                                const isAdmin = data.record && data.record.admin === true;
                                const redirectUrl = isAdmin ? '/admin/dashboard' : '/dashboard';
                                
                                // Immediate redirect (no delay needed)
                                window.location.href = redirectUrl;
                            } else {
                                console.error('No token received from server');
                                this.error = 'Authentication failed - no token received';
                            }
                        } else {
                            this.error = data.message || 'Invalid email or password';
                        }
                    } catch (error) {
                        this.error = 'Login failed. Please try again.';
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }
    </script>
</body>
</html>