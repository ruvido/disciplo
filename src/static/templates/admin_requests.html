<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Requests - {{.AppName}} Admin</title>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; line-height: 1.6; color: #333; background: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .header { background: white; border-bottom: 1px solid #e9ecef; padding: 1rem 0; }
        .nav { display: flex; gap: 2rem; margin-top: 1rem; }
        .nav button { background: none; border: none; padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .nav button.active { border-bottom-color: #333; font-weight: 600; }
        .nav a { text-decoration: none; color: #666; padding: 0.5rem 1rem; border-bottom: 2px solid transparent; }
        .nav a.active { border-bottom-color: #333; font-weight: 600; color: #333; }
        .main { padding: 2rem 0; }
        .card { background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        .btn { background: #333; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn:hover { background: #555; }
        .btn-primary { background: #007bff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-secondary { background: #6c757d; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { text-align: left; padding: 0.75rem; border-bottom: 1px solid #e9ecef; }
        .table th { font-weight: 600; background: #f8f9fa; }
        .status { padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; }
        .status.pending { background: #fff3cd; color: #856404; }
        .status.approved { background: #d1edff; color: #084298; }
        .empty-state { text-align: center; padding: 3rem; color: #666; }
        .request-detail { border: 1px solid #e9ecef; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
        .request-header { display: flex; justify-content: between; align-items: start; margin-bottom: 1rem; }
        .request-info { flex: 1; }
        .request-actions { display: flex; gap: 0.5rem; }
        .request-meta { font-size: 0.875rem; color: #666; margin-bottom: 0.5rem; }
        .request-name { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem; }
        .request-email { color: #666; }
        .request-details { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0; }
        .detail-item { }
        .detail-label { font-weight: 500; margin-bottom: 0.25rem; }
        .detail-value { color: #666; }
        .interests-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .interest-tag { background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.875rem; }
        .why-join { margin: 1rem 0; }
        .why-join-text { background: #f8f9fa; padding: 1rem; border-radius: 6px; font-style: italic; }
        .picture-preview { text-align: center; margin: 1rem 0; }
        .picture-preview img { max-width: 150px; max-height: 150px; border-radius: 8px; border: 1px solid #e9ecef; }
        @media (max-width: 768px) {
            .nav { flex-direction: column; gap: 0; }
            .table { font-size: 0.875rem; }
            .request-details { grid-template-columns: 1fr; }
            .request-header { flex-direction: column; gap: 1rem; }
            .request-actions { width: 100%; justify-content: stretch; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h1>{{.AppName}} Admin</h1>
                <button class="btn btn-outline" onclick="logout()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Sign Out</button>
            </div>
            <nav class="nav">
                <a href="/admin/dashboard">Profile</a>
                <a href="/admin/dashboard">Communities</a>
                <a href="/admin/dashboard">Members</a>
                <a href="/admin/requests" class="active">Requests</a>
            </nav>
        </div>
    </div>

    <div class="main">
        <div class="container">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div>
                        <h2>Membership Requests</h2>
                        <p style="color: #666; margin-top: 0.5rem;">Review and approve new member applications</p>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span style="font-size: 0.875rem; color: #666;">
                            {{len .Requests}} pending requests
                        </span>
                        <button class="btn btn-secondary btn-sm" onclick="location.reload()">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>

                {{if .Requests}}
                    {{range .Requests}}
                    <div class="request-detail" data-request-id="{{.Id}}">
                        <div class="request-header">
                            <div class="request-info">
                                <div class="request-meta">
                                    Request #{{.Id}} ‚Ä¢ Submitted {{.GetDateTime "created"}}
                                </div>
                                <div class="request-name">{{.GetString "name"}}</div>
                                <div class="request-email">{{.GetString "email"}}</div>
                            </div>
                            <div class="request-actions">
                                <button class="btn btn-success btn-sm" onclick="approveRequest('{{.Id}}')">
                                    ‚úÖ Approve
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="rejectRequest('{{.Id}}')">
                                    ‚ùå Reject
                                </button>
                            </div>
                        </div>

                        <div class="request-details">
                            <div class="detail-item">
                                <div class="detail-label">Date of Birth</div>
                                <div class="detail-value">{{.GetDateTime "date_of_birth"}}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Location</div>
                                <div class="detail-value">{{.GetString "city"}}, {{.GetString "location"}}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Job Field</div>
                                <div class="detail-value">{{.GetString "job_field"}}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Interests</div>
                                <div class="detail-value">
                                    <div class="interests-list">
                                        {{range .GetStringSlice "interests"}}
                                        <span class="interest-tag">{{.}}</span>
                                        {{end}}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="why-join">
                            <div class="detail-label">Why they want to join:</div>
                            <div class="why-join-text">
                                "{{.GetString "why_join"}}"
                            </div>
                        </div>

                        {{$profilePicture := .GetString "profile_picture"}}
                        {{if $profilePicture}}
                        <div class="picture-preview">
                            <div class="detail-label">Profile Picture:</div>
                            <img src="/api/files/requests/{{.Id}}/{{$profilePicture}}" alt="Profile Picture">
                        </div>
                        {{end}}
                    </div>
                    {{end}}
                {{else}}
                    <div class="empty-state">
                        <h3>No pending requests</h3>
                        <p>All membership applications have been reviewed.</p>
                        <a href="/admin/dashboard" class="btn" style="margin-top: 1rem;">Back to Dashboard</a>
                    </div>
                {{end}}
            </div>
        </div>
    </div>

    <script>
        async function approveRequest(requestId) {
            if (!confirm('Are you sure you want to approve this request?')) return;

            try {
                const response = await fetch(`/api/admin/approve-request/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.querySelector(`[data-request-id="${requestId}"]`).remove();
                    location.reload(); // Refresh to update counts
                } else {
                    alert('Error approving request: ' + result.message);
                }
            } catch (error) {
                alert('Error approving request: ' + error.message);
            }
        }

        async function rejectRequest(requestId) {
            if (!confirm('Are you sure you want to reject this request? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/admin/reject-request/${requestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    document.querySelector(`[data-request-id="${requestId}"]`).remove();
                    location.reload(); // Refresh to update counts
                } else {
                    alert('Error rejecting request: ' + result.message);
                }
            } catch (error) {
                alert('Error rejecting request: ' + error.message);
            }
        }

        function logout() {
            // Clear all authentication data
            localStorage.removeItem('pb_auth');
            localStorage.removeItem('user_data');
            
            // Clear authentication cookie
            document.cookie = 'pb_auth=; path=/; max-age=-1; samesite=strict';
            
            // Use API logout endpoint for proper server-side cleanup
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    window.location.replace('/login');
                })
                .catch(() => {
                    // Even if API call fails, redirect to login
                    window.location.replace('/login');
                });
        }
    </script>
</body>
</html>